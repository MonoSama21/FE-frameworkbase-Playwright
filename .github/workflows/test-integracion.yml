name: FrontEnd Test - Integracion

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Ingrese el nombre del tag del escenario
        required: true
        type: string
        default: "@test"
      correo:
        description: Ingrese el correo donde llegar√° la notificaci√≥n
        required: true
        type: string
        default: "2101010261@undc.edu.pe"
        
  schedule:
    # Lunes a Viernes 8 AM ‚Äî Tag diario
    - cron: "0 13 * * 1-5"   # 13 UTC = 8AM Per√∫
    # S√°bado y Domingo 7 PM ‚Äî Tag de fin de semana
    - cron: "0 6 * * 6,0"    # 00 UTC = 1:00AM Per√∫

jobs:
  Pruebas-FrontEnd-Integracion:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    permissions:
      contents: write  # üëà Permiso para hacer push a gh-pages
      pages: write     # üëà Permiso para desplegar en GitHub Pages
      id-token: write  # üëà Permiso para autenticaci√≥n

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    # =========================================================
    # üìå ASIGNAR TAG Y CORREO SEG√öN EL TIPO DE DISPARO
    # =========================================================
    - name: Detectar par√°metros para ejecuci√≥n autom√°tica o manual
      id: params
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          echo "correo=${{ github.event.inputs.correo }}" >> $GITHUB_OUTPUT
        else
          # Lunes a Viernes
          if [[ $(date +%u) -lt 6 ]]; then
            echo "tag=@DailyTest" >> $GITHUB_OUTPUT
            echo "correo=2101010261@undc.edu.pe" >> $GITHUB_OUTPUT
          else
            # S√°bado y domingo
            echo "tag=@WeekendTest" >> $GITHUB_OUTPUT
            echo "correo=2101010261@undc.edu.pe" >> $GITHUB_OUTPUT
          fi
        fi

    # =========================================================
    # CORREO INICIAL (HTML)
    # =========================================================
    - name: Notificar inicio de ejecuci√≥n
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "üîµ Pruebas iniciadas - FrontEnd Integraci√≥n"
        to: ${{ steps.params.outputs.correo }}
        from: ${{ secrets.MAIL_USERNAME }}
        html_body: |
          <div style="font-family: Arial; padding: 20px;">
            <h2 style="color:#007bff;">üîµ Ejecuci√≥n iniciada</h2>
            <p>Las pruebas de integraci√≥n han comenzado.</p>
            <p><strong>Tag ejecutado:</strong> <span style="color:#007bff;">${{ steps.params.outputs.tag }}</span></p>
          
            <br>
            <p>Saludos,<br><strong>QA Automation Semisenior Yrvin Pachas</strong></p>
          </div>

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests by tag
      id: run_tests
      run: |
        npm test -- --grep "${{ steps.params.outputs.tag }}"
        echo "resultado=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: List target directory
      run: ls -R target

    # Subir artefacto completo (con videos y traces) a GitHub Actions
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: target/
        retention-days: 30

    # =========================================================
    # üåê DESPLEGAR REPORTE EN GITHUB PAGES
    # =========================================================
    - name: Preparar reporte de Playwright para GitHub Pages
      if: always()
      run: |
        mkdir -p gh-pages
        if [ -d "target/playwright-report" ]; then
          cp -r target/playwright-report/* gh-pages/
          echo "‚úÖ Reporte de Playwright copiado a gh-pages"
        else
          echo "‚ö†Ô∏è No se encontr√≥ el reporte de Playwright"
          echo "<h1>No se gener√≥ reporte</h1>" > gh-pages/index.html
        fi
    
    # =========================================================
    # üìä EXTRAER RESULTADOS DEL REPORTE JSON DE PLAYWRIGHT
    # =========================================================
    - name: Extraer resultados de Playwright
      if: always()
      id: test_results
      run: |
        if [ -f "target/test-results/results.json" ]; then
          # Mostrar primeras l√≠neas del JSON para diagn√≥stico
          echo "üìã Primeras l√≠neas del JSON:"
          head -100 target/test-results/results.json
          echo "================================"
          
          # Extraer estad√≠sticas usando diferentes m√©todos seg√∫n la estructura
          PASSED=$(jq '[.suites[]?.specs[]?.tests[]? | select(.results[]?.status == "passed")] | length' target/test-results/results.json 2>/dev/null || echo "0")
          FAILED=$(jq '[.suites[]?.specs[]?.tests[]? | select(.results[]?.status == "failed" or .results[]?.status == "timedOut")] | length' target/test-results/results.json 2>/dev/null || echo "0")
          SKIPPED=$(jq '[.suites[]?.specs[]?.tests[]? | select(.results[]?.status == "skipped")] | length' target/test-results/results.json 2>/dev/null || echo "0")
          
          # Si no hay datos, intentar estructura alternativa
          if [ "$PASSED" == "0" ] && [ "$FAILED" == "0" ] && [ "$SKIPPED" == "0" ]; then
            PASSED=$(jq '[.. | objects | select(.status? == "passed")] | length' target/test-results/results.json 2>/dev/null || echo "0")
            FAILED=$(jq '[.. | objects | select(.status? == "failed" or .status? == "timedOut")] | length' target/test-results/results.json 2>/dev/null || echo "0")
            SKIPPED=$(jq '[.. | objects | select(.status? == "skipped")] | length' target/test-results/results.json 2>/dev/null || echo "0")
          fi
          
          TOTAL=$((PASSED + FAILED + SKIPPED))
          
          echo "‚úÖ PASSED: $PASSED"
          echo "‚ùå FAILED: $FAILED"
          echo "‚è≠Ô∏è SKIPPED: $SKIPPED"
          echo "üìù TOTAL: $TOTAL"
          
          # Extraer nombres de escenarios y sus estados de forma robusta
          echo "üìù Extrayendo detalles de escenarios..."
          
          # Crear archivos temporales
          > /tmp/scenarios_list.txt
          > /tmp/scenarios_html.txt
          
          # M√©todo 1: Extracci√≥n est√°ndar de Playwright
          echo "Intentando m√©todo 1..."
          jq -r '.suites[]?.specs[]?.tests[]? | "\(.title)|\(.results[0]?.status // "unknown")"' target/test-results/results.json 2>/dev/null | while IFS='|' read -r title status; do
            if [ -n "$title" ] && [ "$title" != "null" ] && [ "$title" != "" ]; then
              echo "  ‚úì Encontrado: $title - $status"
              case "$status" in
                "passed")
                  echo "- ‚úÖ **PASSED**: $title" >> /tmp/scenarios_list.txt
                  echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:green; font-weight: bold;'>‚úÖ PASSED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$title</td></tr>" >> /tmp/scenarios_html.txt
                  ;;
                "failed"|"timedOut")
                  echo "- ‚ùå **FAILED**: $title" >> /tmp/scenarios_list.txt
                  echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:red; font-weight: bold;'>‚ùå FAILED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$title</td></tr>" >> /tmp/scenarios_html.txt
                  ;;
                "skipped")
                  echo "- ‚è≠Ô∏è **SKIPPED**: $title" >> /tmp/scenarios_list.txt
                  echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:gray; font-weight: bold;'>‚è≠Ô∏è SKIPPED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$title</td></tr>" >> /tmp/scenarios_html.txt
                  ;;
              esac
            fi
          done
          
          # Verificar si se capturaron escenarios con m√©todo 1
          if [ ! -s /tmp/scenarios_html.txt ]; then
            echo "M√©todo 1 fall√≥. Intentando m√©todo 2 (estructura alternativa)..."
            # M√©todo 2: Buscar cualquier objeto con title y status
            jq -r '.. | objects | select(.title? and .status?) | "\(.title)|\(.status)"' target/test-results/results.json 2>/dev/null | while IFS='|' read -r title status; do
              if [ -n "$title" ] && [ "$title" != "null" ]; then
                echo "  ‚úì Encontrado (m√©todo 2): $title - $status"
                case "$status" in
                  "passed"|"expected")
                    echo "- ‚úÖ **PASSED**: $title" >> /tmp/scenarios_list.txt
                    echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:green; font-weight: bold;'>‚úÖ PASSED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$title</td></tr>" >> /tmp/scenarios_html.txt
                    ;;
                  "failed"|"unexpected"|"timedOut")
                    echo "- ‚ùå **FAILED**: $title" >> /tmp/scenarios_list.txt
                    echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:red; font-weight: bold;'>‚ùå FAILED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$title</td></tr>" >> /tmp/scenarios_html.txt
                    ;;
                  "skipped")
                    echo "- ‚è≠Ô∏è **SKIPPED**: $title" >> /tmp/scenarios_list.txt
                    echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:gray; font-weight: bold;'>‚è≠Ô∏è SKIPPED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$title</td></tr>" >> /tmp/scenarios_html.txt
                    ;;
                esac
              fi
            done
          fi
          
          # √öltimo recurso: usar los t√≠tulos de specs
          if [ ! -s /tmp/scenarios_html.txt ]; then
            echo "M√©todo 2 fall√≥. Usando specs como fallback..."
            jq -r '.suites[]?.specs[]? | "\(.title)|\(.tests[0]?.results[0]?.status // "passed")"' target/test-results/results.json 2>/dev/null | while IFS='|' read -r title status; do
              if [ -n "$title" ] && [ "$title" != "null" ]; then
                echo "  ‚úì Encontrado (specs): $title - $status"
                case "$status" in
                  "passed")
                    echo "- ‚úÖ **PASSED**: $title" >> /tmp/scenarios_list.txt
                    echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:green; font-weight: bold;'>‚úÖ PASSED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$title</td></tr>" >> /tmp/scenarios_html.txt
                    ;;
                  *)
                    echo "- ‚ùå **FAILED**: $title" >> /tmp/scenarios_list.txt
                    echo "<tr><td style='border: 1px solid #ddd; padding: 10px;'><span style='color:red; font-weight: bold;'>‚ùå FAILED</span></td><td style='border: 1px solid #ddd; padding: 10px;'>$title</td></tr>" >> /tmp/scenarios_html.txt
                    ;;
                esac
              fi
            done
          fi
          
          # Verificar si finalmente se capturaron escenarios
          if [ ! -s /tmp/scenarios_html.txt ]; then
            echo "‚ö†Ô∏è Todos los m√©todos fallaron"
            echo "<tr><td colspan='2' style='border: 1px solid #ddd; padding: 10px; text-align: center; color: orange;'>‚ö†Ô∏è No se pudieron extraer los nombres de los escenarios del JSON</td></tr>" > /tmp/scenarios_html.txt
            echo "- ‚ö†Ô∏è No se pudieron extraer los nombres de los escenarios" > /tmp/scenarios_list.txt
          else
            echo "‚úÖ Escenarios extra√≠dos correctamente"
          fi
          
          # Crear tabla de resumen HTML para el email
          TABLE="<table style='border-collapse: collapse; width: 100%; margin: 20px 0;'>"
          TABLE="$TABLE<tr style='background-color: #f2f2f2;'>"
          TABLE="$TABLE<th style='border: 1px solid #ddd; padding: 12px;'>Total</th>"
          TABLE="$TABLE<th style='border: 1px solid #ddd; padding: 12px; color: green;'>‚úÖ Passed</th>"
          TABLE="$TABLE<th style='border: 1px solid #ddd; padding: 12px; color: red;'>‚ùå Failed</th>"
          TABLE="$TABLE<th style='border: 1px solid #ddd; padding: 12px; color: gray;'>‚è≠Ô∏è Skipped</th>"
          TABLE="$TABLE</tr><tr>"
          TABLE="$TABLE<td style='border: 1px solid #ddd; padding: 12px; text-align: center;'><strong>$TOTAL</strong></td>"
          TABLE="$TABLE<td style='border: 1px solid #ddd; padding: 12px; text-align: center;'><strong>$PASSED</strong></td>"
          TABLE="$TABLE<td style='border: 1px solid #ddd; padding: 12px; text-align: center;'><strong>$FAILED</strong></td>"
          TABLE="$TABLE<td style='border: 1px solid #ddd; padding: 12px; text-align: center;'><strong>$SKIPPED</strong></td>"
          TABLE="$TABLE</tr></table>"
          
          # Agregar tabla de escenarios ejecutados para el email
          SCENARIOS_TABLE="<h3 style='color:#333; margin-top: 20px;'>üìã Escenarios Ejecutados:</h3>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE<table style='border-collapse: collapse; width: 100%; margin: 20px 0;'>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE<tr style='background-color: #f2f2f2;'>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE<th style='border: 1px solid #ddd; padding: 12px; width: 150px;'>Estado</th>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE<th style='border: 1px solid #ddd; padding: 12px;'>Escenario</th>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE</tr>"
          SCENARIOS_TABLE="$SCENARIOS_TABLE$(cat /tmp/scenarios_html.txt)"
          SCENARIOS_TABLE="$SCENARIOS_TABLE</table>"
          
          # Usar delimitador EOF para valores multilinea
          echo "table_html<<EOF" >> $GITHUB_OUTPUT
          echo "$TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "scenarios_table<<EOF" >> $GITHUB_OUTPUT
          echo "$SCENARIOS_TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Crear resumen para GitHub Actions
          echo "## üìä Resultados de las Pruebas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| M√©trica | Cantidad |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| üìù Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚è≠Ô∏è Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Escenarios Ejecutados:" >> $GITHUB_STEP_SUMMARY
          cat /tmp/scenarios_list.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è Archivo results.json no encontrado"
          echo "üìÇ Contenido de target/test-results:"
          ls -la target/test-results/ || echo "Carpeta no existe"
          
          echo "table_html=<p style='color: orange;'>‚ö†Ô∏è No se encontr√≥ el archivo de resultados JSON</p>" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è No se pudo generar el resumen de resultados" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Deploy to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./gh-pages
        publish_branch: gh-pages
        force_orphan: true

    # =========================================================
    # üìß CORREO FINAL CON TABLA DE RESULTADOS Y LINK
    # =========================================================
    - name: Notificar fin de ejecuci√≥n con tabla de resultados
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "üü¢ Pruebas finalizadas - FrontEnd Integraci√≥n"
        to: ${{ steps.params.outputs.correo }}
        from: ${{ secrets.MAIL_USERNAME }}
        html_body: |
          <div style="font-family: Arial; padding: 20px;">
            <img src="https://res.cloudinary.com/dvrsdqsl1/image/upload/v1764399269/Blue_Minimalist_Technology_Cube_Logo_1_x445ab.png" width="180">

            <h2 style="color:#28a745;">üü¢ Pruebas Finalizadas</h2>

            <p><strong>Tag ejecutado:</strong> 
              <span style="color:#28a745;">${{ steps.params.outputs.tag }}</span>
            </p>

            <h3 style="color:#333;">üìä Resultado General:</h3>
            <p>
              Estado: 
              <strong style="color:${{ steps.run_tests.outputs.resultado == '0' && 'green' || 'red' }};">
                ${{ steps.run_tests.outputs.resultado == '0' && 'PASSED' || 'FAILED' }}
              </strong>
            </p>

            ${{ steps.test_results.outputs.table_html }}

            ${{ steps.test_results.outputs.scenarios_table }}

            <h3>üìÑ Reporte en vivo:</h3>
            <p>
              üåê <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" 
              style="color:#007bff; font-size: 18px; font-weight: bold;">Ver Reporte HTML Completo</a>
            </p>

            <p>
              üîó <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
              style="color:#007bff;">Ver ejecuci√≥n en GitHub Actions</a>
            </p>
            
            <p>
              üì¶ <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" 
              style="color:#007bff;">Descargar artefactos (con videos)</a>
            </p>

            <br>
            <p>Saludos,<br><strong>QA Automation Semisenior Yrvin Pachas</strong></p>
          </div>
